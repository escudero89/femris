<!doctype html>
<html lang="es">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <title>FEMRIS</title>
    <meta name="author" content="Cristian Escudero">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="jsxgraph/jsxgraph.css" />

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">

    <meta name="viewport"content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
      <![endif]-->

</head>
<body>
<div class="container-fluid" style="margin-top:1em">
    <div class="row">
        <div class="col-md-5">

            <div class="panel panel-default">
                <input class="btn btn-primary pull-right" type="button" value="Guardar" onclick="updateGraph()"></input>

                <div class="panel-body" onchange="updateShapeFunction()">

                    <div class="form-group">
                        <label>Elige un tipo de Función de Forma</label>
                        <div class="radio">
                            <label class="radio-inline">
                                <input type="radio" name="inlineRadioOptions" id="inlineRadio2" value="option2" checked> Lagrange
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="inlineRadioOptions" id="inlineRadio3" value="option3"> Hermite
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="inlineRadioOptions" id="inlineRadio1" value="option1"> Personalizada
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <div id="singleShapeFunction" class="jxgbox w100p" style="height:34vh" ></div>
                    </div>

                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-addon">N<sub>1</sub></div>
                            <input class="form-control" value="(xj - x) / h" type="text" disabled></input>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-addon">N<sub>2</sub></div>
                            <input class="form-control" value="(x - xi) / h" disabled></input>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-addon">N<sub>3</sub></div>
                            <input class="form-control" value="(x - xi) / h" disabled></input>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-addon">N<sub>4</sub></div>
                            <input class="form-control" value="(x - xi) / h" disabled></input>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-addon">N<sub>5</sub></div>
                            <input class="form-control" value="(x - xi) / h" disabled></input>
                        </div>
                    </div>


                    <div class="form-group">
                        <label>Cantidad de nodos por elemento</label>
                        <select id="quantityOfNodes" class="form-control">
                            <option>2</option>
                            <option selected="selected">3</option>
                            <option>4</option>
                            <option>5</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Posición de nodos internos</label>

                        <div class="row" id="innerNodes">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <div class="input-group-addon">X<sub>2</sub></div>
                                    <input class="form-control" size="5" type="number" step="0.01" min="0" max="1" placeholder="0.25" ></input>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="input-group">
                                    <div class="input-group-addon">X<sub>3</sub></div>
                                    <input class="form-control" type="number" maxlength="5" step="0.01" min="0" max="1" placeholder="0.50" ></input>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <div class="input-group-addon">X<sub>4</sub></div>
                                    <input class="form-control" type="number" maxlength="5" step="0.01" min="0" max="1" placeholder="0.75" ></input>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Cantidad de elementos</label>
                        <select id="quantityOfElements" class="form-control">
                            <option selected="selected">1</option>
                            <option>2</option><option>3</option><option>4</option><option>5</option>
                            <option>6</option><option>7</option><option>8</option><option>5</option>
                            <option>10</option><option>11</option><option>12</option><option>13</option>
                            <option>14</option><option>15</option><option>16</option><option>17</option>
                            <option>18</option><option>19</option><option>20</option>
                        </select>
                    </div>
                    

                </div>
            </div>
        </div>


        <div class="col-md-7">
            <div id="box" class="jxgbox" style="width:100%; height:90vh;"></div>

            <form class="form-inline" role="form">
                <div class="form-group">
                    <div class="input-group">
                        <div class="input-group-addon">N<sub>1</sub></div>
                        <input class="form-control" id="N1" value="(x2 - x) / (x2-x1) * (x3-x)/(x3-x1)" ></input>
                    </div>
                </div>
                <div class="form-group">
                    <div class="input-group">
                        <div class="input-group-addon">N<sub>2</sub></div>
                        <input class="form-control" id="N2" value="(x - x1) / (x2-x1) * (x3 - x) / (x3-x2)" ></input>
                    </div>
                </div>
                <div class="form-group">
                    <div class="input-group">
                        <div class="input-group-addon">N<sub>3</sub></div>
                        <input class="form-control" id="N3" value="(x - x1) / (x3-x1) * (x - x2) / (x3-x2)" ></input>
                    </div>
                </div>
                <input class="btn btn-default" type="button" value="Update Graph!" onclick="updateGraph()"></input>
                </div>
            </form>
        </div>



<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="js/third-party/jquery-1.11.1.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="js/third-party/bootstrap.min.js"></script>

<script type="text/javascript" src="js/third-party/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="js/femris-utils.js"></script>
<script type="text/javascript" src="jsxgraph/jsxgraphcore.js"></script>
<script type="text/javascript">

function updateGraph(interpolationFunction) {

    $("#box").html("");

    var Y_MIN = -0.5;
    var Y_MAX = 10;

    var X_MIN = 0;
    var X_MAX = 2;
    var QUANTITY_OF_ELEMENTS = $("#quantityOfElements").val();
    var QUANTITY_OF_NODES = $("#quantityOfNodes").val();

    function getPointsFromQuantityOfElements() {

        var stepValue = ( X_MAX - X_MIN ) / ( QUANTITY_OF_ELEMENTS * ( QUANTITY_OF_NODES - 1 ) );
        var currentPosition = X_MIN;

        var points = [];

        while (currentPosition <= X_MAX) {
            points.push(currentPosition);
            currentPosition += stepValue;
        }

        return points;
    }

    function getValuesForInterpolation(pointsForElement) {
        
        var phi_m = [];

        $.each(pointsForElement, function(idx, val) {
            phi_m.push(baseFunction(val));
        });

        return phi_m;

    };

    var baseFunction = function(x) {
        return Math.sin(x * 10) + (Y_MAX - Y_MIN) * 0.5 + 1;
    };

    var board = JXG.JSXGraph.initBoard('box', {boundingbox: [X_MIN, Y_MAX, X_MAX, Y_MIN], axis: false, grid:true});

    var basegraph = board.create('functiongraph', [baseFunction], {strokeColor:'#ff0000'});

    var pointsForElement = getPointsFromQuantityOfElements();
    var valuesForPoints = getValuesForInterpolation(pointsForElement);


    board.suspendUpdate();

    var kElem = 0;

    var N = [];
    
    N[1] = $("#N1").val();
    N[2] = $("#N2").val();
    N[3] = $("#N3").val();

    var phi = "";

    for ( var k = 0; k < QUANTITY_OF_NODES ; k++ ) {
        phi += "+ (" + N[k + 1] + ") * phi_vector[" +  k + "] ";
    }

    console.log(phi);
    
    while (kElem < QUANTITY_OF_ELEMENTS) {

        var counterOfSidesDone = QUANTITY_OF_NODES;

        var phi_vector = [];
        var x_vector = [];

        for ( var k = 0; k < QUANTITY_OF_NODES ; k++ ) {
            phi_vector.push(valuesForPoints[k + ( QUANTITY_OF_NODES - 1) * kElem]);
            x_vector.push(pointsForElement[k + ( QUANTITY_OF_NODES - 1 ) * kElem]);
        }

        // Variables for our eval
        var x1 = x_vector[0];
        var x2 = x_vector[1];

        var x3 = (x_vector.length > 2) ? x_vector[2] : 0;
        var x4 = (x_vector.length > 3) ? x_vector[3] : 0;
        var x5 = (x_vector.length > 4) ? x_vector[4] : 0;

        var x_ini = x_vector[0];
        var x_fin = x_vector[ x_vector.length - 1 ];
        
        console.log(x1,x2,x3,x4,x5);

        for ( ; counterOfSidesDone > 0 ; counterOfSidesDone-- ) {

            board.create('functiongraph', [

                function(x) { 

                    var value = 0;

                    if (x >= x_ini && x <= x_fin) {
                        value = eval(N[counterOfSidesDone]);
                    }

                    return value;
                }, x_ini, x_fin], 
                {strokeColor: getColorFromIdx(kElem)}

            );
        }

        board.create('functiongraph', [
            function(x) {
                var value = 0;

                value = eval(phi);

                return value;
            }, x_ini, x_fin],
            {strokeColor: getColorFromIdx(kElem)});

        kElem++;
    }

    var kPoint = 0;

    for ( ; kPoint < pointsForElement.length ; kPoint++ ) {
        var cPoint = pointsForElement[kPoint];

        board.create(
            'point', 
            [cPoint, baseFunction(cPoint)], 
            { color: getColorFromIdx(kPoint), name: '', fixed: true}
        );
    }

}

function lagrangeInterpolation(p) {

    var w = [],
        /** @ignore */
        fct = function (x, suspendedUpdate) {
            var i, j, k, xi, s, M,
                len = p.length,
                num = 0,
                denom = 0;

            if (!suspendedUpdate) {
                for (i = 0; i < len; i++) {
                    w[i] = 1.0;
                    xi = p[i].X();

                    for (k = 0; k < len; k++) {
                        if (k !== i) {
                            w[i] *= (xi - p[k].X());
                        }
                    }

                    w[i] = 1 / w[i];
                }

                M = [];

                for (j = 0; j < len; j++) {
                    M.push([1]);
                }
            }

            for (i = 0; i < len; i++) {
                xi = p[i].X();

                if (x === xi) {
                    return p[i].Y();
                }

                s = w[i] / (x - xi);
                denom += s;
                num += s * p[i].Y();
            }

            return num / denom;
        };

    fct.getTerm = function () {
        return '';
    };

    return fct;
}

function updateShapeFunction() {

    var $innerNodes = $("#innerNodes input");
    var innerNodesValues = [];

    $.each($innerNodes, function(idx, val) {
        innerNodesValues.push($(this).val());
    });

    var board = JXG.JSXGraph.initBoard('singleShapeFunction', {
        boundingbox: [-0.1, 1.5, 1.1, -0.5],
        axis: true,
        grid: false,
        showCopyright: false
    });

    var pointsForPolynomial = [];
    var currentPointPosition = { 
        'x' : 0,
        'y' : 0
    };

    var nodeOptions = {
        size: '4',
        fixed: true,
        name: ''
    }

    var nodeFace = ['o','[]','x','+','^'];

    var elementColor;

    var quantityOfNodes = $("#quantityOfNodes").val();
    var kQuantity;
    var kFunction;

    var stepForNodesLocation = 1 / ( quantityOfNodes - 1 );

    // The outer loop is for each equation, and the inner loop is for each node
    for ( kFunction = 0 ; kFunction < quantityOfNodes ; kFunction++ ) {

        pointsForPolynomial = [];

        elementColor = getColorFromIdx(kFunction, 0.9);
        nodeOptions['color'] = elementColor;
        nodeOptions['face'] = nodeFace[kFunction];

        for ( kQuantity = 0 ; kQuantity < quantityOfNodes ; kQuantity++ ) {

            currentPointPosition.x = kQuantity * stepForNodesLocation;
            currentPointPosition.y = (kFunction === kQuantity) ? 1 : 0;

            if ( kQuantity !== 0 && kQuantity !== quantityOfNodes - 1 ) {

                var currentInnerNodeValue = innerNodesValues[kQuantity - 1];

                if (currentInnerNodeValue !== '') {
                    currentPointPosition.x = currentInnerNodeValue;
                }
            }

            pointsForPolynomial[kQuantity] = board.create(
                'point', 
                [currentPointPosition.x, currentPointPosition.y], 
                nodeOptions
            );
        }

        /// Code for the label
        var nodeLabelXPosition = kFunction * stepForNodesLocation;
        if (kFunction > 0 && kFunction < quantityOfNodes - 1 && innerNodesValues[kFunction - 1] !== '') {
            nodeLabelXPosition = innerNodesValues[kFunction - 1];
        }

        board.create(
            'point', 
            [ nodeLabelXPosition, 0], 
            { name: 'X<sub>' + (kFunction+1) + '</sub>', fixed: true, size: 0});


        /// We draw the function
        board.create('functiongraph', lagrangeInterpolation(pointsForPolynomial), {strokeColor: elementColor});
    }

    updateInputs(quantityOfNodes);
    updateGraph();

}

function updateInputs(quantityOfNodes) {

    var stepForNodesLocation = 1 / ( quantityOfNodes - 1 );
    
    $("#innerNodes input").attr("placeholder", function (idx, val) {

        var returnedPlaceholder = '0.0';

        if (idx < quantityOfNodes - 2) {
            returnedPlaceholder = Math.round(( idx + 1) * stepForNodesLocation * 100000) / 100000;
            $(this).removeAttr('disabled');
        } else {
            $(this).attr('disabled', 'disabled');
        }

        return returnedPlaceholder;
    });

}

$(document).ready(function() {

    updateShapeFunction();
    updateGraph();
/*
    $(window).resize(function() {
        document.location.reload();
    });*/

    console.log();

});
</script>

</body>
</html>
